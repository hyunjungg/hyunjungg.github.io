{"componentChunkName":"component---src-templates-blog-post-js","path":"/exploit/Analyzing_CVE_2023_21768/","result":{"data":{"site":{"siteMetadata":{"title":"Hyunjung's Blog","author":"Hyunjung","siteUrl":"https://hyunjungg.github.io","comment":{"disqusShortName":"","utterances":"hyunjungg/hyunjungg.github.io"},"sponsor":{"buyMeACoffeeId":""}}},"markdownRemark":{"id":"217a8e6f-7e83-552a-aecb-7c28acb7a8f8","excerpt":"이번 글에서는 Windows 11에서 동작하는 LPE취약점인 CVE-2023-21768에 대해 설명합니다.  TOC 1. CVE-2023-21768 2. Concepts A. I/O Ring (1) I/O Ring 기본 (2) The Role of I/O Ring in CVE-2023-21768 (3) I/O Ring API Usage B. AFD.SYS 3. Exploit Explain 4. Ref 1. CVE-2023-21768 취약점은 Winsock처리 드라이버인 afd.sys…","html":"<p>이번 글에서는 Windows 11에서 동작하는 LPE취약점인 CVE-2023-21768에 대해 설명합니다. </p>\n<h3 id=\"toc\" style=\"position:relative;\"><a href=\"#toc\" aria-label=\"toc permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[TOC]</h3>\n<ul>\n<li><a href=\"#1-cve-2023-21768\">1. CVE-2023-21768</a></li>\n<li>\n<p><a href=\"#2-concepts\">2. Concepts</a></p>\n<ul>\n<li><a href=\"#a-i-o-ring\">A. I/O Ring</a></li>\n<li><a href=\"#-1--i-o-ring---\">(1) I/O Ring 기본</a></li>\n<li><a href=\"#-2--the-role-of-i-o-ring-in-cve-2023-21768\">(2) The Role of I/O Ring in CVE-2023-21768</a></li>\n<li><a href=\"#-3--i-o-ring-api-usage\">(3) I/O Ring API Usage</a></li>\n<li><a href=\"#b-afdsys\">B. AFD.SYS</a></li>\n</ul>\n</li>\n<li><a href=\"#3-exploit-explain\">3. Exploit Explain</a></li>\n<li><a href=\"#4-ref\">4. Ref</a></li>\n</ul>\n<h1 id=\"1-cve-2023-21768\" style=\"position:relative;\"><a href=\"#1-cve-2023-21768\" aria-label=\"1 cve 2023 21768 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1. CVE-2023-21768</h1>\n<p>취약점은 Winsock처리 드라이버인 afd.sys에서 발생합니다.\n이는 afd.sys가 I/O Control (IOCTL) 요청을 처리하는 과정에서의 보안 검사 결함으로 인해 발생하게 되는데요. 공격자는 특별히 제작된 IOCTL 요청을 afd 드라이버로 보내어 이 취약점을 악용할 수 있으며, 이를 통해 상승된 권한으로 임의의 코드를 실행할 수 있습니다.</p>\n<p>취약점의 영향을 받는 버전은 Windows 11H2, AFD.sys 10.0.22621.608 이하이며, POC는 <a href=\"https://github.com/chompie1337/Windows_LPE_AFD_CVE-2023-21768\">여기</a>서 확인하실 수 있습니다.</p>\n<h1 id=\"2-concepts\" style=\"position:relative;\"><a href=\"#2-concepts\" aria-label=\"2 concepts permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2. Concepts</h1>\n<p>이 섹션에서는 취약점을 이해하기 위해 필요한 개념인 I/O Ring 과 AFD.SYS 에 대해 설명합니다</p>\n<h2 id=\"a-io-ring\" style=\"position:relative;\"><a href=\"#a-io-ring\" aria-label=\"a io ring permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>A. I/O Ring</h2>\n<p>간단히 말하면  <strong>I/O ring은 Windows의 새로운 I/O 비동기 메커니즘입니다.</strong>\nI/O Ring은 여러 개의 I/O 작업을 I/O Ring 큐에 집어넣은 후 한꺼번에 커널 쪽에 전달하는 방식을 사용합니다. </p>\n<p>Windows 비동기 I/O 작업이라고 하면 다들 <strong>I/O Ring</strong>이 아닌 전통적인 <strong>Overlapped I/O</strong> 방식을 떠올리실 것 같습니다. 하지만 Overlapped I/O 방식은 I/O의 Read/Write 작업이 발생할 때마다 필수적으로 커널 모드전환이 필요합니다. 이는 많은 오버헤드를 발생시킵니다. </p>\n<p>반면에 I/O Ring의 경우 I/O 작업에 대한 호출들을 일괄 전달함으로써 단 한 번의 커널 전환만 하기 때문에 CPU 사용을 효율적으로 할 수 있습니다. </p>\n<h3 id=\"1-io-ring-기본\" style=\"position:relative;\"><a href=\"#1-io-ring-%EA%B8%B0%EB%B3%B8\" aria-label=\"1 io ring 기본 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>(1) I/O Ring 기본</h3>\n<p>아직 Windows I/O Ring은 모든 동작을 지원하지 않습니다. 현재까지 Windows 11 22H2에서 가능한 동작은 read, write, flush, cancle 등이 있습니다.</p>\n<p>요청된 동작은 <strong>Submission Queue</strong>에 작성되고, 커널로 제출되어집니다. 이후 커널은 요청을 수행하고 <strong>Completion Queue</strong>에 결과 상태 코드를 작성합니다. </p>\n<p>앞서 언급한 작업(read, write, flush ..) 외에도, 추가적으로 두 가지 타입의 작업을 큐에 넣을 수 있습니다. 바로 Preregister buffers와 Preregister files입니다.  이 옵션들을 통해 애플리케이션은 미리 모든 파일 핸들을 열거나 모든 버퍼를 생성하고, 이들을 등록한 후에 I/O Ring을 통해 큐에 넣은 I/O 작업에서 인덱스로 이들을 참조할 수 있게 됩니다. 커널이 Preregister Buffers 혹은 Preregister files을 사용하는 항목을 처리할 때, 요청된 handle/buffer를 사전등록된 배열에서 가져와서 I/O 매니저에 전달게 됩니다. 이후에는 일반 I/O Ring 동작과 동일하게 처리됩니다.  </p>\n<p>작업들이 큐잉된 Submission Queue의 예시 모습은 다음과 같습니다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 770px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 61.66666666666666%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAAA7DAAAOwwHHb6hkAAACaUlEQVQoz2VTa4vTQBTNn/YXiH4S/CJ+EURYhQVdUBDqh1Vc7XZtd1tqa9/dPtKkSdNHmvckk8zxzrSrKw5MLrmZc+bk3nM1y7JEt9uFruuCNlzXRRRFyNIUEJxigjiOwQoOjgI8k7kMeZ7Dtm2Jk1GA1tXVldDCMMR6vRaSyPd9BeA5hx/F6E08fPkZofdpiOi8j3C6RlakSJIEKUsxHo/RarUwGo1QFIWo1WrQpDIixG63E85qhZgx8CDAxdcp3l74OG/4uC1P4L9vYfuyCqPUR14oQTAMA8PhEIvFQiWq1arQJpMJTNNU8hmRBSyBefYZv56eYb706VihwDnFzQ8d/Qd92OW1yqVJCvmHcsulFHLO1QtJVjFytpg+fIXtt4Z6F6Tm7pt86i8MTJ5MEUahEjEcDDGfz/8SprL4CngAubcL3D5/h8Ba/8kLQaT54TeXZQfNR2PEbgJrZaHT6WA2m0HyVCqVe4TiAJDybaql7PR9wvxI2Kpv8OGNgSTmCAKf1Omyqarrl5eX/xNmWaas4/qessn9lcYM52cOLkorOpfQ5qrud5fX6/V/CVWtKHphAPtmjP33EdguIACDuY9wWjNx8noGe+GjII/q+gLSw7LTkvj6+hoaqVGGXi6XQvor5zm4KOA259ie3CCk/bHUw+OyiWcVA11zd2gQXSxJ9vu9VCiOTREa+Q+9Xk/IwjqOc5gKOsh4hnDrIe3b6HQttFchvCCCyDMi8VRnV1RrWfOjC0Sj0YBGHhTNZhPtdlvIQ57nKdKYJiVJGWKe0vQw5DSCjDwaUZ7GFRIzGAyw2WwkRimkpojffiuCNWu+x9YAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Untitled\"\n        title=\"Untitled\"\n        src=\"/static/d88e06f9ce259482eac0555c4a066bb1/f4b77/Untitled.png\"\n        srcset=\"/static/d88e06f9ce259482eac0555c4a066bb1/5a46d/Untitled.png 300w,\n/static/d88e06f9ce259482eac0555c4a066bb1/0a47e/Untitled.png 600w,\n/static/d88e06f9ce259482eac0555c4a066bb1/f4b77/Untitled.png 770w\"\n        sizes=\"(max-width: 770px) 100vw, 770px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span></p>\n<h3 id=\"2-the-role-of-io-ring-in-cve-2023-21768\" style=\"position:relative;\"><a href=\"#2-the-role-of-io-ring-in-cve-2023-21768\" aria-label=\"2 the role of io ring in cve 2023 21768 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>(2) The Role of I/O Ring in CVE-2023-21768</h3>\n<p>CVE-2023-21768을 이해하기 위한 I/O Ring의 역할을 설명하겠습니다.</p>\n<p>앞서 언급했듯이, I/O Ring을 사용하는 어플리케이션은 추후 I/O 작업에서 사용될 버퍼나 핸들들을 미리 등록해 놓을 수 있습니다. 이 Preregistered Buffers는 I/O Ring Object를 통해 참조됩니다.</p>\n<p>I/O Ring Object의 구조체는 아래와 같습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token keyword\">typedef</span> <span class=\"token keyword\">struct</span> <span class=\"token class-name\">_IORING_OBJECT</span>\n<span class=\"token punctuation\">{</span>\n    USHORT Type<span class=\"token punctuation\">;</span>\n    USHORT Size<span class=\"token punctuation\">;</span>\n    NT_IORING_INFO UserInfo<span class=\"token punctuation\">;</span>\n    PVOID Section<span class=\"token punctuation\">;</span>\n    PNT_IORING_SUBMISSION_QUEUE SubmissionQueue<span class=\"token punctuation\">;</span>\n    PMDL CompletionQueueMdl<span class=\"token punctuation\">;</span>\n    PNT_IORING_COMPLETION_QUEUE CompletionQueue<span class=\"token punctuation\">;</span>\n    ULONG64 ViewSize<span class=\"token punctuation\">;</span>\n    ULONG InSubmit<span class=\"token punctuation\">;</span>\n    ULONG64 CompletionLock<span class=\"token punctuation\">;</span>\n    ULONG64 SubmitCount<span class=\"token punctuation\">;</span>\n    ULONG64 CompletionCount<span class=\"token punctuation\">;</span>\n    ULONG64 CompletionWaitUntil<span class=\"token punctuation\">;</span>\n    KEVENT CompletionEvent<span class=\"token punctuation\">;</span>\n    UCHAR SignalCompletionEvent<span class=\"token punctuation\">;</span>\n    PKEVENT CompletionUserEvent<span class=\"token punctuation\">;</span>\n    ULONG RegBuffersCount<span class=\"token punctuation\">;</span>\n    PVOID RegBuffers<span class=\"token punctuation\">;</span>\n    ULONG RegFilesCount<span class=\"token punctuation\">;</span>\n    PVOID<span class=\"token operator\">*</span> RegFiles<span class=\"token punctuation\">;</span>\n\t<span class=\"token punctuation\">}</span> IORING_OBJECT<span class=\"token punctuation\">,</span> <span class=\"token operator\">*</span>PIORING_OBJECT</code></pre></div>\n<p>만약 preregister 등록 요청이 들어오면 다음과 같은 일들이 순차적으로 일어나게 됩니다. (이해를 위해 간략하게 요약했습니다. 상세한 과정을 알고 싶으신 분들은 <a href=\"https://windows-internals.com/one-i-o-ring-to-rule-them-all-a-full-read-write-exploit-primitive-on-windows-11/\">이 글</a>을 참고해 주세요!)</p>\n<p><strong>①</strong> IoRing→RegBuffers와 IoRing→RegBuffersCount가 0으로 설정됩니다.</p>\n<p><strong>②</strong> 요청이 유저모드에서 온 경우, 배열의 주소가 유저모드 공간에 위치해 있는지 검증됩니다.</p>\n<p><strong>③</strong> 검증이 완료되면 <strong>커널은 페이징풀 메모리를 할당하고</strong>, 이 메모리에 사용자 모드 배열로부터 데이터를 복사합니다. 이 메모리 주소는 IoRing→RegBuffers가 가리키게 됩니다.</p>\n<p>이렇게 하여 데이터가 오직 유저 모드로부터 왔는지 확인함으로써, 우연히 커널 영역에 read, write, overflow가 발생하는 것을 방지합니다. </p>\n<p>그러나, arbitrary kernel write 버그를 사용할 수 있다면 어떨까요?</p>\n<p>IoRing→RegBuffers 값을 임의로 덮어쓰기 하여, 완전히 제어할 수 있는 가짜 메모리 주소를 가리키도록 한다면 커널 주소 공간을 완전히 제어할 수 있게 됩니다. <strong>커널은 한 번 등록된 register buffer 배열은 안전하다고 생각하고 주소 영역에 대한 추가 검사는 하지 않기 때문입니다.</strong></p>\n<p><strong>즉, arbitrary kernel write bug를 활용하여 full arbitray kernel read/write 버그를 사용할 수 있는 겁니다!</strong></p>\n<h3 id=\"3-io-ring-api-usage\" style=\"position:relative;\"><a href=\"#3-io-ring-api-usage\" aria-label=\"3 io ring api usage permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>(3) I/O Ring API Usage</h3>\n<p>아래는 I/O Ring을 사용하여 파일을 읽는 간단한 예제 코드입니다.\nPOC코드를 이해하는 데에 있어서 I/O Ring API에 대한 간략한 이해가 필요하기 때문에, 각 함수에 대해 간단히 설명하고 넘어가겠습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\">HRESULT result<span class=\"token punctuation\">;</span>\nIORING_CREATE_FLAGS flags<span class=\"token punctuation\">;</span>\nHIORING handle <span class=\"token operator\">=</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">;</span>\nHANDLE hFile <span class=\"token operator\">=</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">;</span>\nPVOID<span class=\"token operator\">*</span> buffer <span class=\"token operator\">=</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">;</span>\n\nflags<span class=\"token punctuation\">.</span>Required <span class=\"token operator\">=</span> IORING_CREATE_REQUIRED_FLAGS_NONE<span class=\"token punctuation\">;</span>\nflags<span class=\"token punctuation\">.</span>Advisory <span class=\"token operator\">=</span> IORING_CREATE_ADVISORY_FLAGS_NONE<span class=\"token punctuation\">;</span>\nresult <span class=\"token operator\">=</span> <span class=\"token function\">CreateIoRing</span><span class=\"token punctuation\">(</span>IORING_VERSION_3<span class=\"token punctuation\">,</span> flags<span class=\"token punctuation\">,</span> <span class=\"token number\">0x1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x1</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>handle<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token function\">SUCCEEDED</span><span class=\"token punctuation\">(</span>result<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t<span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Failed creating IO ring handle : 0x%x\\n\"</span><span class=\"token punctuation\">,</span> result<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token keyword\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">do</span> <span class=\"token punctuation\">{</span>\n\thFile <span class=\"token operator\">=</span> <span class=\"token function\">CreateFile</span><span class=\"token punctuation\">(</span>L<span class=\"token string\">\"C:\\\\WINDOWS\\\\SYSTEM32\\\\notepad.exe\"</span><span class=\"token punctuation\">,</span>\n\t\t\t\t\tGENERIC_READ<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span> OPEN_EXISTING<span class=\"token punctuation\">,</span> FILE_ATTRIBUTE_NORMAL<span class=\"token punctuation\">,</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>hFile <span class=\"token operator\">==</span> INVALID_HANDLE_VALUE<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t<span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Failed opening file handle : 0x%x\\n\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">GetLastError</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t<span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token punctuation\">}</span>\n\n\tIORING_HANDLE_REF reqFile <span class=\"token operator\">=</span> <span class=\"token function\">IoRingHandleRefFromHandle</span><span class=\"token punctuation\">(</span>hFile<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\treqFile<span class=\"token punctuation\">.</span>Kind <span class=\"token operator\">=</span> IORING_REF_RAW<span class=\"token punctuation\">;</span>\n\n\tbuffer <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>PVOID<span class=\"token operator\">*</span><span class=\"token punctuation\">)</span><span class=\"token function\">VirtualAlloc</span><span class=\"token punctuation\">(</span><span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x200</span><span class=\"token punctuation\">,</span> MEM_COMMIT<span class=\"token punctuation\">,</span> PAGE_READWRITE<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>buffer <span class=\"token operator\">==</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t<span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Failed to allocate memory\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t<span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token punctuation\">}</span>\n\n\tIORING_BUFFER_REF reqBuffer <span class=\"token operator\">=</span> <span class=\"token function\">IoRingBufferRefFromPointer</span><span class=\"token punctuation\">(</span>buffer<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\treqBuffer<span class=\"token punctuation\">.</span>Kind <span class=\"token operator\">=</span> IORING_REF_RAW<span class=\"token punctuation\">;</span>\n\n\tresult <span class=\"token operator\">=</span> <span class=\"token function\">BuildIoRingReadFile</span><span class=\"token punctuation\">(</span>handle<span class=\"token punctuation\">,</span> reqFile<span class=\"token punctuation\">,</span> reqBuffer<span class=\"token punctuation\">,</span> <span class=\"token number\">0x200</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span> IOSQE_FLAGS_NONE<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token function\">SUCCEEDED</span><span class=\"token punctuation\">(</span>result<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t<span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Failed building IO ring read file structure : 0x%x\\n\"</span><span class=\"token punctuation\">,</span> result<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t<span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token punctuation\">}</span>\n\n\tresult <span class=\"token operator\">=</span> <span class=\"token function\">SubmitIoRing</span><span class=\"token punctuation\">(</span>handle<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token function\">SUCCEEDED</span><span class=\"token punctuation\">(</span>result<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t<span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Failed submitting IO ring: 0x%x\\n\"</span><span class=\"token punctuation\">,</span> result<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t<span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token punctuation\">}</span>\n\n\tIORING_CQE cqe <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\tresult <span class=\"token operator\">=</span> <span class=\"token function\">PopIoRingCompletion</span><span class=\"token punctuation\">(</span>handle<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>cqe<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token function\">SUCCEEDED</span><span class=\"token punctuation\">(</span>result<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t<span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token punctuation\">}</span>\n\n\t<span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Result code : %x \\n\"</span><span class=\"token punctuation\">,</span> result<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n\t<span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Data from file:\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\tULONG64 endOfBuffer<span class=\"token punctuation\">;</span>\n\tendOfBuffer <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>ULONG64<span class=\"token punctuation\">)</span>buffer <span class=\"token operator\">+</span> <span class=\"token number\">0x200</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">;</span> <span class=\"token punctuation\">(</span>ULONG64<span class=\"token punctuation\">)</span>buffer <span class=\"token operator\">&lt;</span> endOfBuffer<span class=\"token punctuation\">;</span> buffer<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t<span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"%p \"</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">*</span>buffer<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token punctuation\">}</span>\n\t<span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span> <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>false<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>handle <span class=\"token operator\">!=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t<span class=\"token function\">CloseIoRing</span><span class=\"token punctuation\">(</span>handle<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>hFile<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t<span class=\"token function\">CloseHandle</span><span class=\"token punctuation\">(</span>hFile<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>buffer<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t<span class=\"token function\">VirtualFree</span><span class=\"token punctuation\">(</span>buffer<span class=\"token punctuation\">,</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span> MEM_RELEASE<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<ul>\n<li><code class=\"language-text\">CreateIoRing()</code> : IoRing 객체 생성. 유저모드와 커널모드에 각각 객체가 생성됨.</li>\n<li><code class=\"language-text\">IoRingHandleRefFromHandle</code> : 핸들을 통해 *<strong>*IORING<em>HANDLE</em>REF**</strong> 구조체 생성. 이 구조체는 I/O Ring 작업에 사용되는 핸들에 대한 참조임.</li>\n<li><code class=\"language-text\">BuildIoRingReadFile()</code> : IoRing의 <strong>Submission Queue</strong>에 읽기 작업을 넣음. (≒ ReadFileEx)</li>\n<li><code class=\"language-text\">SubmitIoRing()</code> : <strong>Submission Queue</strong>의 작업들을 커널에 제출하고 완료를 기다림.</li>\n</ul>\n<h2 id=\"b-afdsys\" style=\"position:relative;\"><a href=\"#b-afdsys\" aria-label=\"b afdsys permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>B. AFD.SYS</h2>\n<p>앞서 언급한 대로, I/O Ring을 통해 커널 주소 공간을 제어하기 위해서는 arbitrary kernel write bug가 필요합니다. 이를 위해 afd.sys 드라이버에서 발생하는 취약점을 활용하는데요, afd.sys드라이버가 뭔지 간략하게 알아보겠습니다.</p>\n<p>AFD.SYS 드라이버란 “Ancillary Function Driver for Winsock”의 약자로, Windows 소켓 2.0에서 제공하는 TCP/IP 프로토콜 기능을 지원하기 위해 설계된 Windows 커널 모드 드라이버 입니다.</p>\n<p>아래는 <a href=\"https://recon.cx/2015/slides/recon2015-20-steven-vittitoe-Reverse-Engineering-Windows-AFD-sys.pdf\">Defcon 2015</a> 발표 자료에서 참고한, Winsock 처리 관련 모듈들이 정리된 자료입니다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 669px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 100.33333333333334%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAACXBIWXMAABcRAAAXEQHKJvM/AAADvElEQVQ4y4VUa3PaRhTlz/c/tP3SNukk4ySOHcd2AD/AAfMQGCxhEEg8zEtggbEFBsxDe3p2cTKl0zaauXOl1e7Zc+65uwFN2/MymQ+Ixd4IXd9HpRKHrn+W30ildlAsfoFtX6LXi6JQ2IwnkzuoVkNoNs9xd9eF543FbDbjOl0EqtVDr98/4oSPYjQKc2GSEeTkT+h0DuA4IdzfXwHIYDgMc94ubm/3MZ1GsV4nsViM8fKIer2OgGVFvGr1hEyCotuNod830G7HUSp94eJTDAZZsjAwn+e4UYwKgqjVTjAeZ/DwkMZs5kEICIlYrVZFoFDQPNPMwrLyoly+gmleo9G44cIcmRT5XsTz8zNWKx/L5Yp5rWK53GRBNN/38QKIgG0feq3WEer1A+E4QTLUIL8bjc+Ufch8RGkL/N+zBWgYWa9YVMzI8JrS8wQxKTlHYIthcxOHsvtw3TtGn2XYZDm2Wq0Uy++A7fa5Bxj8kRO+n8fjY5wAEdYrQvcSZJejZI0SNRqU4sYHuL5+R8d3qSDI8Qle8DaAxeKlV6+nyUoTjUaGC+Ks3RVbRbpdoLMmGZWYS3Td5Lw8yuUka56meTpdnm0DWlbSc12d9HUxHN5AvssNDCPKRUlOShI8pd6bzQwmE4sOV1S4rkH2T99rqQBNM+x5XhbdblxYVpgtcUaHw6zdBRlc8PsrgS5Us5tmULWSbZ+o/44TV22zBdhqhThyxUaNK5cHg1PKO6NzGqVkKDvB+sqmlj15pv73eiHW94Jgl+zPx23ATueEgDqbNCrS6VfQtNd0+j1BUpySpUEJyA2fnxM04y1yuTeUv8cxaVaSgN6/AV6zNjGe5R0W/KNaINltGCbJJMPiS5dPKTXMekfo/pXqgv8AzEv6CtAwdgi4r9j5forMLciDP516ygAZ8/mE32M1tl6vt/uw291IHo0i4ubmHeV+QIUs12tZwxSZN/CjZ+uklCun3iNdHt6nxf1Ikxkyj0YZuIME8+3mKvnWbD8CLN0cPz64MfTaEVHI7yHPu7FhB3F/x5unTWddGz6xlsulOmZ/Dyl3OByy5brsSZelsnhSfvtp7aTfohN7JSrBX1E6/hm30d/hXP6JVvwPOOFdzB88TOeyjtOtkLVtNpvs1RpPWYMXckoE+ge/+L5ziVX9XDwUjuHmDvBUDmFWCeHJDmOSCGHlTbAgo8VisRXfWMssq6IY2tn82LXq6Jm2cK0aBnYD3WIFxtcE9GgctUIRTq/Hc9xR0v4Zg8FAhuBxQzabFX8BptOxwVZb8psAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Untitled\"\n        title=\"Untitled\"\n        src=\"/static/06e3ac7b77a8bbdc9663d2b716ed1a1f/99272/Untitled1.png\"\n        srcset=\"/static/06e3ac7b77a8bbdc9663d2b716ed1a1f/5a46d/Untitled1.png 300w,\n/static/06e3ac7b77a8bbdc9663d2b716ed1a1f/0a47e/Untitled1.png 600w,\n/static/06e3ac7b77a8bbdc9663d2b716ed1a1f/99272/Untitled1.png 669w\"\n        sizes=\"(max-width: 669px) 100vw, 669px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span></p>\n<h1 id=\"3-exploit-explain\" style=\"position:relative;\"><a href=\"#3-exploit-explain\" aria-label=\"3 exploit explain permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>3. Exploit Explain</h1>\n<p>취약점이 발생하는 부분은 afd.sys 의 <code class=\"language-text\">afd!AfdNotifyRemoveIoCompletion</code> 함수 내부입니다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 960px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 19.333333333333332%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAIAAAABPYjBAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAmUlEQVQI1z2OwRLDIAhE8z2CosJqkpke0qantv//O8U4kz2xsPBYjs9LoRSIIxORiBhs3fq29/2xm1mFcbyUkhfMPGsPL8/fGxtCCN5zn1KSJFqSZs45q6nfUlgupRqqmWSp3mjwC758apvksSy5AOAh4qk4DU3vGbpGg3x8T+12vx2vx5zUVAa2o63NGkqtjquAk/0RrM2Tf/J9LdBd04s/AAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Untitled\"\n        title=\"Untitled\"\n        src=\"/static/5d524ca47730d75b0a8ff0ebb3c830fe/d9199/Untitled2.png\"\n        srcset=\"/static/5d524ca47730d75b0a8ff0ebb3c830fe/5a46d/Untitled2.png 300w,\n/static/5d524ca47730d75b0a8ff0ebb3c830fe/0a47e/Untitled2.png 600w,\n/static/5d524ca47730d75b0a8ff0ebb3c830fe/d9199/Untitled2.png 960w\"\n        sizes=\"(max-width: 960px) 100vw, 960px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span></p>\n<p>이때, 공격자가 unkownAFDStruct의 field_18값을 제어할 수 있다면, arbitrary kernel Write-Where primitive가 활성화됩니다. writeValue의 값은 <code class=\"language-text\">KeRemoveQueueEx</code> 의 반환 값이며, 이 값은 인자로 전달된 Queue에서 제거된 항목의 count값 입니다. <a href=\"https://securityintelligence.com/posts/patch-tuesday-exploit-wednesday-pwning-windows-ancillary-function-driver-winsock/\">분석에 따르면 이 값은 항상 1이 었다고 합니다.</a> 즉, 원하는 주소의 값을 0x1로 수정할 수 있게 됩니다.</p>\n<p><code class=\"language-text\">afd!AfdNotifyRemoveIoCompletion</code> 내부로 진입하기 위해, POC코드에서는 AFD드라이버와 직접 통신하는 방법을 사용합니다. (상응하는 Windows API는 모르지만, IOCTL Code는 알기 때문입니다.) </p>\n<p>따라서 직접 AFD 디바이스 오브젝트를 통해 handle을 얻습니다. 아래 코드를 참고해 주세요.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 1200px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 10.999999999999998%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAACCAYAAABYBvyLAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAX0lEQVQI113MUQqAIBCEYe9RuxUWGBgK5SZkPXj/O01FUeDDB//DMMptGcueEeIKFwUxHZA1YjQGjR7Q9hpMBOILPZj565KykjDJBhGB9TOMD+h0j7qq/uF7cB9x0aUTWs05EqmKacMAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Untitled\"\n        title=\"Untitled\"\n        src=\"/static/f4a2eccddfd3efd052c889af5cb3a330/c1b63/Untitled3.png\"\n        srcset=\"/static/f4a2eccddfd3efd052c889af5cb3a330/5a46d/Untitled3.png 300w,\n/static/f4a2eccddfd3efd052c889af5cb3a330/0a47e/Untitled3.png 600w,\n/static/f4a2eccddfd3efd052c889af5cb3a330/c1b63/Untitled3.png 1200w,\n/static/f4a2eccddfd3efd052c889af5cb3a330/8affb/Untitled3.png 1254w\"\n        sizes=\"(max-width: 1200px) 100vw, 1200px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span></p>\n<p>핸들을 정상적으로 얻었다면 <code class=\"language-text\">DeviceIoContorlFile()</code> 을 통해 드라이버와 통신합니다. 이때, unknownAFDStruct 구조체의 값은 DeviceIoControlFile에서 사용되는 InputBuffer 값입니다.(7번째 인자)</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 1200px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 38.666666666666664%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAABcRAAAXEQHKJvM/AAABEElEQVQoz53Q7UrDMBgF4DhBZSKIBQXbNE2/Zpt+p3PtUHDKpiL+ELyI3f8F9Jhug9XCKvjj4UBCzvsS8rx8xfQ+b8p6jiCOESUFIjFVJIQokaY1OHeg6zoMSjfoALJcrRopU6RigpAxBNyG07KdTbq2C9uywC0Gru4tZoJR4yDiRQU8kTWOyEC9CKYbw3AFjCCF4cdgfnuewLxLQP0IuhvihrmKt8vfyJlX4Sp8wIVKYkoQptBiy2zlu+xg8rATf4axKrzMFtDkE85FhZEjccTlfkBff0DXafgIbf6Oa7lQxRWOnRLEKvYPWTFc0DeazBr/4xt6/gJym223Mge2+8s4fwP9XDda/QVipJ1/+58fJ37cEPkZi24AAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Untitled\"\n        title=\"Untitled\"\n        src=\"/static/e5090539cb29828b9ba1ff692a49c173/c1b63/Untitled4.png\"\n        srcset=\"/static/e5090539cb29828b9ba1ff692a49c173/5a46d/Untitled4.png 300w,\n/static/e5090539cb29828b9ba1ff692a49c173/0a47e/Untitled4.png 600w,\n/static/e5090539cb29828b9ba1ff692a49c173/c1b63/Untitled4.png 1200w,\n/static/e5090539cb29828b9ba1ff692a49c173/d61c2/Untitled4.png 1800w,\n/static/e5090539cb29828b9ba1ff692a49c173/025a1/Untitled4.png 1857w\"\n        sizes=\"(max-width: 1200px) 100vw, 1200px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span></p>\n<p>실제로 <code class=\"language-text\">afd!AfdNotifyRemoveIoCompletion</code> 에 breakpoint를 걸어 확인해 보겠습니다. 이 함수에서 unknownAFDStruct 값은 세 번째 파라미터로 전달됩니다. </p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 1119px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 26.333333333333336%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAYAAABFA8wzAAAACXBIWXMAABcRAAAXEQHKJvM/AAABGElEQVQY022Q226CQBRF/f/PMsEaFWSGDgyIFkmqMVVBRhRvszql6VtPsrPX087KGQyHQzudTomiyCqlKIqC7XbD8XjENA2nU83ZGC7tmefjQXe70V477vc7N8dd1/X9xwM3RJ7nVmtNmqZ8rEt2XwdMe+V86TiZC41jc71xuT+p9jWbZEWz2/PfDSaTiRVCIERo/WCOjDPke0ysM5Yfa3S+IglClqMx2huReW/krvV4hjGtM/21+zG21vaDSCmtC6GQLNefFM5SxRqdLUh0SpZm5CohCQULFaOdgJIJjTnzer1o27Yf6w09z7NBEOD7vnXpzeZS4YeSQER9hBubO+tZGBE6DiJFpBcc3J+rqqIsS+q6pnE//wa9/W1HAr+8IAAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Untitled\"\n        title=\"Untitled\"\n        src=\"/static/6736c791d11221c97a9f1cbf51b586a7/33a7b/Untitled5.png\"\n        srcset=\"/static/6736c791d11221c97a9f1cbf51b586a7/5a46d/Untitled5.png 300w,\n/static/6736c791d11221c97a9f1cbf51b586a7/0a47e/Untitled5.png 600w,\n/static/6736c791d11221c97a9f1cbf51b586a7/33a7b/Untitled5.png 1119w\"\n        sizes=\"(max-width: 1119px) 100vw, 1119px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span></p>\n<p>세 번째 파라미터 값을 확인한 후 메모리 내용을 보면 InputBuffer로 넣은 값이 보입니다.</p>\n<p>위 코드에서 알 수 있듯이, InputBuffer에서 0x18~0x20번째 값에는 0x1로 수정할 주소값이 들어있습니다. 수정할 주소값은 I/O RING 오브젝트의 RegBuffers + 0x3 부분이므로 (I/O Ring + 0xbb) 해당 주소를 확인해 보면, 아래 그림처럼 IORING_OBJECT를 확인하실 수 있습니다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 970px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 44.99999999999999%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAABcRAAAXEQHKJvM/AAABbElEQVQoz5WRbU/CMBSF9///ktEPM4qO0b21boMJjMHeN+QtYBg97jbhizGoJzlt1+Se3edWC8NQOo4Dx7GlEBzj8Vh5MpnA9wMwxhBFkfJsNsN+v8fhcFD7T9ba9RpsNJLMERj5MZrdJ66qqhKWZWOxWCBJEhRFgdPphOPxCCklLpcLuq5TO33TWavqWnLXgckjeSc+cC8aPPgbsPiArGzAPQ+GYSjrug4hBIiIKLIsw3Q6xXK5VD+M4xha07R9kQseRHgRCdgkh58dkW06lGWlAgl13ZNQQNu2fecV8jxX57IsUde1uiNrtJimCa/vcmQM4FomitUCkB2apsFut8N/pFER5xxv/QNYng/mCgxtjmSVY7vdKtNsSNdZ3bIKdGwbrggwFHMY3jt0NgbjIeL5TL024ZGuRTc7JH5jOITZ++lRx+vgGTYzka6Waj7fsX8NpIIgCHpsAWZZCMJQDZtEuGma4nw+/ymM9AXGSaGTsQRvbwAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Untitled\"\n        title=\"Untitled\"\n        src=\"/static/f6185181280c2b8912e53b3226c558c0/587b0/Untitled6.png\"\n        srcset=\"/static/f6185181280c2b8912e53b3226c558c0/5a46d/Untitled6.png 300w,\n/static/f6185181280c2b8912e53b3226c558c0/0a47e/Untitled6.png 600w,\n/static/f6185181280c2b8912e53b3226c558c0/587b0/Untitled6.png 970w\"\n        sizes=\"(max-width: 970px) 100vw, 970px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span></p>\n<p>결론적으로, InputBuffer 내의 데이터 일부에 쓰인 주소에 해당되는 값을 afd.sys 드라이버에서 0x1로 변경하기 때문에 일어나는 취약점입니다.</p>\n<p>따라서 이 취약점을 사용하면, 위 I/O Ring 설명 부분에서 언급했던 IoRing→RegBuffers 의 주소의 일부를 1로 수정할 수 있습니다.! 그림과 함께 좀 더 상세히 살펴보겠습니다.</p>\n<p>아래는 I/O Ring Object를 생성했을 때 모습입니다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 1069px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 41%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAABcRAAAXEQHKJvM/AAABTUlEQVQoz5VRTW+CUBDk//8NL8abiYm2XrwYvxAeUBFTFKtikA8FQUq0vOny0npqY9xk8uawb3ZnVnIchzOmwjDeuL1cIQwCgg/XdcEYw3a7Ffx4POJ6vf6LoigEpIAENKbyiWFjvPAQf3KUAC55TkMMWJYlsF6v4fs+oigSHy+Xi0BOfRV+SzocfM7UKUbWnr8aIXrzGL1FCjdMYegaJrIM0zShqqoQ1nVdiJMz2LZ952VZ3gWpSYMxm2Mok8W9j6z4QpZlojFJEtxuN2Hr9/2Lc85/BD0PqqKIbeTJmPgUu80GWZoiJ0vPVCUq+WHI9bkJzd7wwXyDgfmBoelgS4NWdJCAjlFVZan68AhSQLbUdpsrLx0Mmk3o3S7sfh8eZRXOZjjvdk9tKa0Y40qjgVG9zvu1GmatFiI6xIlieO90cFoucaY8kzgWeT7CN0MPVW2Kxp1eAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Untitled\"\n        title=\"Untitled\"\n        src=\"/static/f459fde55fedb791d6de684f6c2dc174/e2e58/Untitled7.png\"\n        srcset=\"/static/f459fde55fedb791d6de684f6c2dc174/5a46d/Untitled7.png 300w,\n/static/f459fde55fedb791d6de684f6c2dc174/0a47e/Untitled7.png 600w,\n/static/f459fde55fedb791d6de684f6c2dc174/e2e58/Untitled7.png 1069w\"\n        sizes=\"(max-width: 1069px) 100vw, 1069px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span></p>\n<p>취약점을 사용하여 RegBuffers + 0x3 바이트를 0x1로 변경해줍니다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 411px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 6.666666666666667%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAABCAYAAADeko4lAAAACXBIWXMAAAsTAAALEwEAmpwYAAAASElEQVQI1x3FWwqAIBRAwTYjKKFe35phtP9FnaSPYQ6Rk1rd5rln/G9daM3TN20jymZCysh8cePBhchai3ENSikopZDkMUbzAfcQH9Ptv4VuAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Untitled\"\n        title=\"Untitled\"\n        src=\"/static/793cd0c095fa9a3cc95506739511f725/2a432/Untitled8.png\"\n        srcset=\"/static/793cd0c095fa9a3cc95506739511f725/5a46d/Untitled8.png 300w,\n/static/793cd0c095fa9a3cc95506739511f725/2a432/Untitled8.png 411w\"\n        sizes=\"(max-width: 411px) 100vw, 411px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span></p>\n<p>이후 I/O Ring Object를 확인해보면, 아래와 같이 주소값이 <code class=\"language-text\">0x1000000</code>으로 변하게 됩니다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 1069px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 41.333333333333336%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAABcRAAAXEQHKJvM/AAABbElEQVQoz3WR626CQBCFef9XaWLSpm1irIlterEVBZcKGlGIVosLWIuARmBPh601xtRJvuz8mD0zZ0ZxHEfomgbDeBf2aIzA9wmO2WwGXdcxnU5lvlwusdvtzrLdbiWK7wfo6ppoGTbeBh5WG4ECQJKm1MRAv9+XuK4LzjnCMJQfkySRpFRX8hfKYsFpwjZerbmosgAN6wuNwRqzYA3GumipKkzThEYuSmHGmBQnZ7Bt+5AXRbEXpK5lkdHro6mSxU+OeJsjjmO4VBhFEbIsk7byPD/k5XucCyH2gp4nuxskqrZa0DodfEwmiNdrpGRJRll8zJkoRRUehoJZJtjQFU3TwUvvlyk1cuggIU3472eyWAqcovDxGNrtjVBrDTxc19G5u4f99Aiv28WCjjKnS8dUEw2HyOjaGTUpguDslMrEMASrVKBWrsTzxSWsah0RiXwTdq0G3mwipMOU74pW891uIxqNkGw2cs+n/ACYX1MxPmQJuwAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Untitled\"\n        title=\"Untitled\"\n        src=\"/static/493e4adcb3763920253df7d385ee8302/e2e58/Untitled9.png\"\n        srcset=\"/static/493e4adcb3763920253df7d385ee8302/5a46d/Untitled9.png 300w,\n/static/493e4adcb3763920253df7d385ee8302/0a47e/Untitled9.png 600w,\n/static/493e4adcb3763920253df7d385ee8302/e2e58/Untitled9.png 1069w\"\n        sizes=\"(max-width: 1069px) 100vw, 1069px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span></p>\n<p>(설명은 생략했지만 취약점을 두 번 사용해서 바로 위 필드인 RegBuffersCount 값도 변경해 주어야합니다!)</p>\n<p>RegBuffers 의 값이 <code class=\"language-text\">0x1000000</code>으로 변경되었으니, 유저 모드에서 <code class=\"language-text\">0x1000000</code> 주소를 할당받아 사용하면 되겠죠?</p>\n<p>이를 활용하면, SystemToken 주소값을 구할 수 있습니다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 1200px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 55.00000000000001%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAABcRAAAXEQHKJvM/AAAB+klEQVQoz3WS626bQBCFad0mDhjfkkZpzN3ALgvY2PiKb2mCihKlah6g//r+r+DTsbFVu0p/fDqzI/ZwdjRS1/W38XQFkaRb0RcYxSHWQqDgDKnjwuAcjuvC8zy4pL4nwFgE3w+pJ8B5j/oMmqZB13VIlmlBBOFWCB+2bUGj5g6TPjA79+jcf0VnrwcOPU3rnKDBMAwYe0PH2fI4RTickybwghA+pxRRb1+LIEZAsEDAFxEcn8MNBWzHKU1Mk9Qsa0Jq8yluhgX0xRvupt/R6i9x21uhFS+h9hZoiQz1MEMrWqBN2iSuwzmU7hCyPYDsnCMpbIHL8AnVLIeyLFCfveIufUWY/gSLn2EHT3CjR+hsBknrQ+okJUb6PirPIEc5GpMCalqgnXxDK1yh4a9QD1b7WiXawRqKT7ANsYZkDslgWOopKl/gihLW+QY3gxxf0hyX/rz8mzWCZJPapNYYH+0JKgf+GqbnqMHuyTlqlKARbVB1p/jkTHDhjFHVEih6gs/6oLx8xj9GR/May6D0X2C9/IaW/4L38AZtSim7ZEpGsjFA5b0k5n8MFTZHjWZoz37AGz8joFnejgpUKKW0S3aaTj9y6B/PRzPjMENFPOLaHdGuTWj3JmjS05vRA2S2hEyjqHozXNAo5IDWRcxJM1yx3b3Z/vzhJOEfPDA2A5Xjy3IAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Untitled\"\n        title=\"Untitled\"\n        src=\"/static/781f456bde8bb93382834539a3b7c66b/c1b63/Untitled10.png\"\n        srcset=\"/static/781f456bde8bb93382834539a3b7c66b/5a46d/Untitled10.png 300w,\n/static/781f456bde8bb93382834539a3b7c66b/0a47e/Untitled10.png 600w,\n/static/781f456bde8bb93382834539a3b7c66b/c1b63/Untitled10.png 1200w,\n/static/781f456bde8bb93382834539a3b7c66b/bd44e/Untitled10.png 1643w\"\n        sizes=\"(max-width: 1200px) 100vw, 1200px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span></p>\n<p><code class=\"language-text\">BuildIoRingWriteFile()</code> 함수를 통해 두 번째 인자인 <strong>reqFile</strong>에 <strong>reqBuffer</strong>의 내용이 쓰이게 됩니다. </p>\n<p>위 코드의 118번째 라인을 참고해 보면, <strong>reqBuffer</strong>는 <strong>IoRingBufferRefFromIndexAndOffset</strong> 을 통해 Preregister 배열의 0번째 index에서 값을 참고합니다. </p>\n<p>0번째 index에 담겨있는 값은 위 코드에서 <strong>pMcBufferEntry</strong> 구조체에 담겨있습니다. </p>\n<p>결론적으로, <code class=\"language-text\">BuildIoRingWriteFile()</code> 을 통해 SytemToken 주소값 얻을 수 있는 것입니다.</p>\n<p>이제 이 SystemToken 값을 권한을 상승시킬 Target 프로세스의 EPROCESS 객체 Token 부분에 덮어씌우면 됩니다.!</p>\n<p>방법은 아래 그림과 같습니다.</p>\n<p><code class=\"language-text\">WriteFile()</code>을 통해 SystemToken값을 named pipe에 작성 해 준후, <code class=\"language-text\">BuildIoRingReadFile()</code>을 통해 named pipe에 있는 SystemToken값을  reqBuffer가 참고하는 주소에 적습니다.</p>\n<blockquote>\n<p>poc 코드 상에서 namedpipe를 사용함에도, 변수 이름으로 reqFile을 사용한 것에 대해 혼동이 없으셨으면 합니다.</p>\n<p>(+) named pipe가 아닌 file로 해도 괜찮습니다만, 포렌식을 더욱 어렵게 하기 위해 pipe를 사용했다고 합니다.</p>\n</blockquote>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 1200px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 51.33333333333333%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAABcRAAAXEQHKJvM/AAABm0lEQVQoz42SW2+CQBSE0TZqwEvjFW1RQKiICnJRBKy01tjW9PbS9K3//19MD1ojaTXpw+TssuTL7MwyzWsTnXEIZbKEYPho6Q6u+jYuBy6tbXT0Ke0dKPRd1izwA4fOLNQkHVWp/0dMcRCBNR5QCV5RmK7Bmne4MO5RHC7BDu/AaSFYPURN9dCSbNS6E3CKh7Q0QVp0dzMhptCfI2eskF8QdP6Ipv8C3tpAdN7RMp7Ajx7QpHPuegZGsMC0bZr2bh5TabBATl+i1AvQM0K0tRmqok2ytqqRi4bkgRPMHXAP7TjHVdRvtsC8fovCKALX95FVfaTlGVIKiZyl6YoZJUSm6yOnznEue6ehsUN2uEJpdI+ys0YjzrEXUh4ezuKs1N3MKsH/gRktQk6eIq/526APWf1cUUiuxwfYNrdfwLiUwniDzvoL7egDcrBBw7olR8ddpPbrJDT5T/ws8uYj+OgTdf8NYviMkhEdXCUbFBINH4PtS8lSKXVqVx4GEM0FpPEKvDZHpeuRpqhIDsqSiyq9wbrqotx1T0K/AZjbF87lvXUmAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Untitled\"\n        title=\"Untitled\"\n        src=\"/static/b109973831a4410002115d64178c6ae5/c1b63/Untitled11.png\"\n        srcset=\"/static/b109973831a4410002115d64178c6ae5/5a46d/Untitled11.png 300w,\n/static/b109973831a4410002115d64178c6ae5/0a47e/Untitled11.png 600w,\n/static/b109973831a4410002115d64178c6ae5/c1b63/Untitled11.png 1200w,\n/static/b109973831a4410002115d64178c6ae5/9eaa0/Untitled11.png 1676w\"\n        sizes=\"(max-width: 1200px) 100vw, 1200px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span></p>\n<p>최종적으로 SystemToken 값이 권한 상승 Target 프로세스의 Token 값에 덮어씌워진 걸 확인할 수 있습니다.!</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 1041px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 84.66666666666669%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAARCAYAAADdRIy+AAAACXBIWXMAABcRAAAXEQHKJvM/AAADBUlEQVQ4y32Ta5OaSBiF/f//Jp9StfttMskkiKBcR/GCIIKoXBRQATk5zY67k9RsuuqtFmhPv+f00wPp6UtnDWWMOE++fYP28gLl6Qvi7RbnokSaZjhkZ+ySAml2QsLnLM9xzEtk5wpFWeFUlF17v2Ok291gn6b4Lsud5cyhmK+wVx7CJMfSDxDt9wjjHZzNDtoywtLbwNv4WK1WsJcbRIcU51OOy+UKjs6erzDIwqhT//4LjiR3hmRg8kOH+qLjdaghcWYo1h6O82Vf0XSOdLlGHu9xPB6QZxlOp5Nw0ZXFGcZ00Q2SIMD3z59h0e413IKrgDQBshRcjfvxCEvWuInaV+LvgKbBR8Nylhik+QljXcPEMLBw19iEIVx/Q6sxWi5qug7bKETKjY7cqOO7O9+1bYs7cxNz07b/CSZJiqEkQRmNMBIly5i+vmIxnyOieFkU8DyPOV1QliUN5DSQIGEJuzE3Pp/P7zrkqamKAk3TYNs2Elp8jI6diC5msxky5iWePypxwr9Y/sr81MkEJgXr3/Kp66YX3AqM3jr5XfD+XnAfbBGu1/CERVqryd6ZXZbEqb32OODefnwIj/GLoK3pMFUVhjLCVJvAUkeY6RPEvke4A6SE1z9UWMcnopL0mSXcLCTo11uDlo4elu25i0HO0H8MJdgEe2gu8HVMuL093OgInxBvdzHcIMJ6E2LDTYJg09tfuD5/b3Eg/CKKS1VBNWyesutC+fQJztMzfEWHS+aW0hiBquHCGGp+91UTrmJhIZsIdQcNT7dhDFVV4spYRLVNjYk15aEcDpCen6ERmUtOmDu239asVqSPlrgYmkUSdOicq+Lyv1n2Vy8hV+p4jDGxUTiPmKeijmFaFmHOe2gty8QujnCrb30V5LFgVBVtCjaF5TvX9YKCQ5kwK2TR0HXMafPArgV3oq6iQ96ikJDXt7oXEWJCpHwTFoALEv7pkCcmBMWfLHb1YO09EuKb4zi43W5/xOffq/fMDCVeP9M0e4EHsGI0xEJ03Xf7xuWfbspP8XX3Erf1KdYAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Untitled\"\n        title=\"Untitled\"\n        src=\"/static/bda53416372531c2202e5204b0b3269f/ee9b6/Untitled12.png\"\n        srcset=\"/static/bda53416372531c2202e5204b0b3269f/5a46d/Untitled12.png 300w,\n/static/bda53416372531c2202e5204b0b3269f/0a47e/Untitled12.png 600w,\n/static/bda53416372531c2202e5204b0b3269f/ee9b6/Untitled12.png 1041w\"\n        sizes=\"(max-width: 1041px) 100vw, 1041px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span></p>\n<p>아래는 POC 영상입니다.</p>\n<p><img src=\"https://github.com/hyunjungg/hyunjungg.github.io/assets/81854943/f616caaf-b945-4393-9518-eaf5e927a798\" alt=\"Untitled\"></p>\n<h1 id=\"4-ref\" style=\"position:relative;\"><a href=\"#4-ref\" aria-label=\"4 ref permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>4. Ref</h1>\n<ul>\n<li><a href=\"https://windows-internals.com/i-o-rings-when-one-i-o-operation-is-not-enough/\">I/O Ring</a></li>\n<li><a href=\"https://www.sysnet.pe.kr/2/0/13065?pageno=0\">I/O Ring 사용 후기</a></li>\n<li><a href=\"https://recon.cx/2015/slides/recon2015-20-steven-vittitoe-Reverse-Engineering-Windows-AFD-sys.pdf\">Defcon afd.sys</a></li>\n<li><a href=\"https://securityintelligence.com/posts/patch-tuesday-exploit-wednesday-pwning-windows-ancillary-function-driver-winsock/\">cve-2023-21768 분석</a></li>\n</ul>","frontmatter":{"title":"Analyzing CVE-2023-21768: the LPE Vulnerability in Windows 11","date":"May 23, 2023"}}},"pageContext":{"slug":"/exploit/Analyzing_CVE_2023_21768/","previous":{"fields":{"slug":"/threat_hunting/Threat_Hunting_Detecting_APT37_TTPs/"},"frontmatter":{"title":"Threat Hunting: Detecting APT37 TTPs"}},"next":null}},"staticQueryHashes":["3128451518","3609235153"]}